name: Sync to GitCode

on:
  push:
    branches: [ main, master ]  # 当推送到 main 或 master 分支时触发
  workflow_dispatch:            # 允许手动点击按钮触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source codes
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 必须设置为0，获取完整的 commit 历史，否则无法镜像

      - name: Push to GitCode
        run: |
          # 配置 GitCode 远程地址 (使用 Secrets 中的用户名和 Token)
          # 注意：这里默认 GitCode 仓库名和 GitHub 仓库名一致
          # 如果不一致，请将 ${{ github.event.repository.name }} 替换为具体的 GitCode 仓库名
          
          REMOTE_URL="https://${{ secrets.GITCODE_USERNAME }}:${{ secrets.GITCODE_TOKEN }}@gitcode.com/${{ secrets.GITCODE_USERNAME }}/${{ github.event.repository.name }}.git"
          
          echo "Adding GitCode remote..."
          git remote add gitcode $REMOTE_URL
          
          echo "Pushing to GitCode..."
          # --force 确保强制覆盖（镜像模式）
          # --all 推送所有分支
          # --tags 推送所有标签
          git push gitcode --all --force
          git push gitcode --tags --force