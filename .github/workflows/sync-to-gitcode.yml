name: Sync to GitCode

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source codes
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to GitCode
        run: |
          # -------------------------------------------------------
          # 1. 硬编码目标仓库信息 (根据您提供的 URL)
          # -------------------------------------------------------
          TARGET_OWNER="Epivitae"
          TARGET_REPO="FIA-Fluorescence-Image-Aligner"
          
          # 2. 拼接认证 URL
          # 格式: https://<用户名>:<Token>@gitcode.com/<Owner>/<Repo>.git
          # 注意：这里我们强制使用了 Epivitae 作为路径，不再依赖 secrets.GITCODE_USERNAME 来决定路径
          # 这样可以防止 Secret 用户名与 URL 不一致导致的 403 错误
          
          REMOTE_URL="https://${{ secrets.GITCODE_USERNAME }}:${{ secrets.GITCODE_TOKEN }}@gitcode.com/${TARGET_OWNER}/${TARGET_REPO}.git"
          
          echo "Target Repo: https://gitcode.com/${TARGET_OWNER}/${TARGET_REPO}.git"
          
          # 3. 添加远程并推送
          if git remote | grep -q "gitcode"; then
            git remote remove gitcode
          fi
          
          git remote add gitcode $REMOTE_URL
          
          echo "Pushing refs..."
          git push gitcode --all --force
          git push gitcode --tags --force